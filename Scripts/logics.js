
var DECKS_LIST = [
  {
    "name":"Orichalcos",
    "cards":[
      { "type": "deck", "name":"orichalcos_magician_apprendice", "amount":2},
      { "type": "deck", "name":"Terror of Atlantis", "amount":1},
      { "type": "deck", "name":"burning_will_for_the_seal", "amount":2},
      { "type": "deck", "name":"arrogance_of_orichalcos", "amount":2},
      { "type": "deck", "name":"attack_guidance_barrier", "amount":2},
      { "type": "deck", "name":"call_of_the_orichalcos_servant", "amount":2},
      { "type": "deck", "name":"divine_basilisk_geh", "amount":1},
      { "type": "deck", "name":"eternal_divine_wrath", "amount":1},
      { "type": "deck", "name":"impudence_of_orichalcos", "amount":2},
      { "type": "deck", "name":"light_barrier_of_the_stolen_souls", "amount":2},
      { "type": "deck", "name":"mirror_knight_calling", "amount":1},
      { "type": "token", "name":"mirror_knight_token", "amount":4},
      { "type": "deck", "name":"orichalcos_aristeros", "amount":1},
      { "type": "deck", "name":"orichalcos_dexia", "amount":1},
      { "type": "deck", "name":"orichalcos_deuteros", "amount":1},
      { "type": "deck", "name":"orichalcos_gigas", "amount":1},
      { "type": "deck", "name":"orichalcos_kiseichu", "amount":1},
      { "type": "deck", "name":"orichalcos_kynerza", "amount":2},
      { "type": "deck", "name":"orichalcos_malevolence", "amount":2},
      { "type": "deck", "name":"orichalcos_kyutora", "amount":1},
      { "type": "deck", "name":"orichalcos_magic_stone", "amount":2},
      { "type": "deck", "name":"orichalcos_magician", "amount":2},
      { "type": "deck", "name":"orichalcos_magician_girl", "amount":2},
      { "type": "deck", "name":"orichalcos_magnetia", "amount":2},
      { "type": "deck", "name":"orichalcos_matia", "amount":2},
      { "type": "deck", "name":"orichalcos_mirror", "amount":1},
      { "type": "deck", "name":"orichalcos_punos", "amount":2},
      { "type": "deck", "name":"orichalcos_shunoros", "amount":1},
      { "type": "deck", "name":"orichalcos_tritos", "amount":1},
      { "type": "deck", "name":"sword_of_sealing", "amount":2},
      { "type": "token", "name":"sentinel_token", "amount":9},
      { "type": "deck", "name":"the_seal_of_orichalcos", "amount":1},
      { "type": "extra", "name":"sealed_sacred_tree", "amount":2},
      { "type": "extra", "name":"orichalcos_true_form", "amount":1},
      { "type": "extra", "name":"orichalcos_talisman_trader", "amount":1},
      { "type": "extra", "name":"orichalcos_last_defender", "amount":2},
      { "type": "extra", "name":"orichalcos_golem", "amount":2},
      { "type": "extra", "name":"orichalcos_eva", "amount":1},
      { "type": "extra", "name":"gizonda_curse_of_the_diferent_dimention", "amount":1},
      { "type": "extra", "name":"fossil_dragon_orichalcos", "amount":1},
      { "type": "extra", "name":"orichalcos_ancient_soldier", "amount":1},
      { "type": "extra", "name":"orichalcos_chimera_blaze", "amount":2},
      { "type": "extra", "name":"levonia_the_orichalcos_chaos_prince", "amount":1},
    ]
  },
  {
    "name":"Blue Eyes White Dragon",
    "cards":[
      { "type": "deck", "name":"Deep eyes white dragon", "amount":2},
      { "type": "deck", "name":"Blue eyes white dragon", "amount":3},
      { "type": "deck", "name":"Blue-Eyes Alternative White Dragon", "amount":3},
      { "type": "deck", "name":"Blue-Eyes Abiss Dragon", "amount":2},
      { "type": "deck", "name":"Dragon spirit of white", "amount":1},
      { "type": "deck", "name":"The White Stone of Ancients", "amount":3},
      { "type": "deck", "name":"The White Stone of Legend", "amount":2},
      { "type": "deck", "name":"Sage with Eyes of Blue", "amount":3},
      { "type": "deck", "name":"Return of the Dragon Lords", "amount":3},
      { "type": "deck", "name":"Polymerization", "amount":2},
      { "type": "deck", "name":"Pot of Desires", "amount":2},
      { "type": "deck", "name":"Trade in", "amount":2},
      { "type": "deck", "name":"Cards of Consonance", "amount":2},
      { "type": "deck", "name":"Dragon Shrine", "amount":3},
      { "type": "deck", "name":"The Melody of Awakening Dragon", "amount":3},
      { "type": "deck", "name":"Mystical space typhoon", "amount":2},
      { "type": "deck", "name":"Silver's Cry", "amount":2},
      { "type": "extra", "name":"Blue eyes alternative ultimate dragon", "amount":1},
      { "type": "extra", "name":"Neo Blue-Eyes Ultimate Dragon", "amount":1},
      { "type": "extra", "name":"Blue-Eyes Twin Burst Dragon", "amount":2},
      { "type": "extra", "name":"Azure eyes silver dragon", "amount":2},
      { "type": "extra", "name":"Blue-Eyes Spirit Dragon", "amount":2},
      { "type": "extra", "name":"Shooting Riser Dragon", "amount":1},
      { "type": "extra", "name":"Number 46 Dragluon", "amount":1},
      { "type": "extra", "name":"Galaxy-Eyes Cipher Blade Dragon", "amount":1},
      { "type": "extra", "name":"Galaxy-Eyes Full Armor Photon Dragon", "amount":1},
      { "type": "extra", "name":"Galaxy-Eyes Cipher Dragon", "amount":1},
      { "type": "extra", "name":"Number 38 Hope Harbinger Dragon Titanic Galaxy", "amount":1},
      { "type": "extra", "name":"Linkuriboh", "amount":1},
    ]
  },
  {
    "name":"Red Eyes Black Dragon",
    "cards":[
      { "type": "deck", "name":"dark_magician", "amount":2},
      { "type": "deck", "name":"red_eyes_black_dragon", "amount":3},
      { "type": "deck", "name":"red_eyes_darkness_metal_dragon", "amount":1},
      { "type": "deck", "name":"red_eyes_alternative_black_dragon", "amount":3},
      { "type": "deck", "name":"tenyi_spirit_vishuda", "amount":3},
      { "type": "deck", "name":"red_eyes_retro_dragon", "amount":2},
      { "type": "deck", "name":"red_eyes_baby_dragon", "amount":2},
      { "type": "deck", "name":"black_metal_dragon", "amount":3},
      { "type": "deck", "name":"the_black_stone_of_legend", "amount":3},
      { "type": "deck", "name":"red_eyes_fusion", "amount":3},
      { "type": "deck", "name":"cards_of_the_red_stone", "amount":3},
      { "type": "deck", "name":"the_claws_of_hermos", "amount":2},
      { "type": "deck", "name":"inferno_fire_blast", "amount":3},
      { "type": "deck", "name":"red_eyes_insight", "amount":3},
      { "type": "deck", "name":"red_eyes_spirit", "amount":3},
      { "type": "deck", "name":"red_eyes_fang_with_chain", "amount":3},
      { "type": "deck", "name":"return_of_the_red_eyes", "amount":3},
      { "type": "deck", "name":"red_eyes_burn", "amount":2},
      { "type": "deck", "name":"eternal_soul", "amount":1},
      { "type": "extra", "name":"meteor_black_comet_dragon", "amount":1},
      { "type": "extra", "name":"red_eyes_dark_dragoon", "amount":2},
      { "type": "extra", "name":"red_eyes_black_dragon_sword", "amount":2},
      { "type": "extra", "name":"red_eyes_flare_metal_dragon", "amount":2},
      { "type": "extra", "name":"mecha_phantom_beast_dracossack", "amount":1},
      { "type": "extra", "name":"number_11_big_Eye", "amount":1},
      { "type": "extra", "name":"saryuja_skull_dread", "amount":1},
      { "type": "extra", "name":"darkness_metal_the_dragon_of_dark_steel", "amount":1},
      { "type": "extra", "name":"bujinki_ahashima", "amount":1},
      { "type": "extra", "name":"wee_witchs_apprentice", "amount":1},
      { "type": "extra", "name":"Union Carrier", "amount":1},
      { "type": "extra", "name":"relinquished_anima", "amount":1},
    ]
  }
];

var CARDS_COUNTER = 0;
var PAGE = null;

function addCard(cardPath, disable_backs){

  if(cardPath == "back.png" && disable_backs){
    return;
  }

  let horizMARGIN = "2.5%";
  let vertMARGIN = "2.6%";

  let img = document.createElement("img");
  img.style.width = "28%";
  img.src = "./Core_All_Cards/"+cardPath;
  img.style.marginTop = vertMARGIN;

  if(cardPath == "back.png")
  {
    img.style.transform = "scale(1.03)";
  }

  // FIRST ROW CARD
  if((CARDS_COUNTER/3)%3 == 0 || ((CARDS_COUNTER-1)/3)%3 == 0 || ((CARDS_COUNTER-2)/3)%3 == 0){
    img.style.marginTop = "7.5%";
  }


  // LEFT CARD
  if(CARDS_COUNTER%3 == 0){
    img.style.marginLeft = "5.55%";
  }
  // MIDDLE CARD
  if(CARDS_COUNTER%3 == 1){
    img.style.marginLeft = horizMARGIN;
    img.style.marginRight = horizMARGIN;
  }
  // RIGTH CARD
  if(CARDS_COUNTER%3 == 2){
    img.style.marginRight = horizMARGIN;
  }

  if(CARDS_COUNTER%9 == 0){
    PAGE = document.createElement("div");
    PAGE.id = "page " + ((CARDS_COUNTER/9) + 1).toString();
    PAGE.style.border = "1px solid";
    PAGE.style.overflow = "hidden";
    PAGE.style.width = (2480/2.2).toString() + "px";
    PAGE.style.height = (3508/2.2).toString() + "px";
    document.body.appendChild(PAGE);
  }

  PAGE.appendChild(img);

  /*
  if([0,1,2,15,16,17].indexOf(CARDS_COUNTER) == -1){
    img.style.opacity = "0";
  }
  */

  CARDS_COUNTER++;
}

function getDeckByName(deck_to_print){
  let deck = [];
  for(let i = 0; i < DECKS_LIST.length; i++){
    if(DECKS_LIST[i]["name"] == deck_to_print){
      deck = DECKS_LIST[i]["cards"];
    }
  }
  return deck;
}

function displayDeck(deck_to_print, disable_backs){

  document.body.style.margin = "0";

  let deck = getDeckByName(deck_to_print);

  if(deck == null || deck == undefined){
    alert("You selected a deck that does not exist in the list: "+ deck_to_print);
    return;
  }

  deck.sort((a,b)=>{
    if(a["name"] < b["name"]){ return -1;}
    if(a["name"] > b["name"]){ return 1;}
    return 0;
  });

  let cards = 0;
  let perfected_deck = [];
  for(let i = 0; i < deck.length; i++){
    for(let j = 0; j < deck[i]["amount"];j++){
      perfected_deck.push(deck[i]["name"]+".png");
      cards++;
      if(perfected_deck.length%9 == 0 && perfected_deck.length > 0){
        for(let k = 0; k < 9; k++){
          perfected_deck.push("back.png");
        }
      }
    }
  }


  let deck_padding_perfect = 9 - cards%9;
  if(deck_padding_perfect != 9){
    while(deck_padding_perfect > 0){
      perfected_deck.push("placeholder.png");
      deck_padding_perfect--;
    }
    for(let k = 0; k < 9; k++){
      perfected_deck.push("back.png");
    }
  }

  for(let i = 0; i < perfected_deck.length; i++){
    addCard(perfected_deck[i], disable_backs);
  }

}

function clearPage(){
  while(document.body.firstChild){
    document.body.removeChild(document.body.firstChild);
  }
}

function process_deck() {

  let deck_name = document.getElementById("chosen_id").value;
  let allow_backs = document.getElementById("allow_back_check").checked;

  clearPage();

  displayDeck(deck_name, !allow_backs);
}

function deck_descr(deck_to_print){

  let deck = getDeckByName(deck_to_print);

  let count_deck = 0;
  let count_extra = 0;
  let count_tokens = 0;
  for(let i = 0; i < deck.length; i++){
    if(deck[i]["type"] == "deck"){
      count_deck+= deck[i]["amount"];
    }
    if(deck[i]["type"] == "extra"){
      count_extra+= deck[i]["amount"];
    }
    if(deck[i]["type"] == "token"){
      count_tokens+= deck[i]["amount"];
    }
  }

  return (deck_to_print + " Deck has the follwing cards structure:<ul><li><div style=\"display:inline-block; padding-top:0.3em; min-width:10em;\">Deck card(s): </div>" + count_deck  + "</li><li><div style=\"display:inline-block; padding-top:0.3em; min-width:10em;\">Extra Deck  card(s): </div>" + count_extra + "</li><li><div style=\"display:inline-block; padding-top:0.3em; min-width:10em;\">Token card(s): </div>" + count_tokens + "</li></ul>");
}


function tell_deck() {
  let deck_name = document.getElementById("chosen_id").value;
  let descr = deck_descr(deck_name);
  document.getElementById("description").innerHTML = descr;
}

function makeSelect(options, onchance){
  let s = makeNode("select",null,null);
  s.onchange = onchance;
  s.style.padding = "0.5em 1em";
  s.style.width = "30em";
  for(let i = 0; i < options.length; i++){
    let o = makeNode("option",options[i], null);
    o.value = options[i];
    s.appendChild(o);
  }
  return s;
}

function makeNode(type, innerHTML, className){
  let d = document.createElement(type);
  if(innerHTML != null){
    d.innerHTML = innerHTML;
  }
  if(className != null){
    d.className = className;
  }

  return d;
}

function setId(element, id){
  element.id = id;
  return element;
}

function makeButton(text, className, onclick){
  let d = document.createElement("button");
  d.innerHTML = text;
  d.style.padding = "0.5em 1em";
  if(className != null){
    d.className = className;
  }
  if(onclick != null){
    d.onclick = onclick;
  }
  return d;
}

function makeCheckBox(text, id) {

  let label = document.createElement("label");

  let check = document.createElement("input");
  check.type = "checkbox";
  check.id = id;

  let wrd = document.createElement("span");
  wrd.innerHTML = text;

  label.appendChild(check);
  label.appendChild(wrd);

  return label;
}

function makeSpace(count){
  let e = document.createElement("div");
  for(let i = 0; i < count; i++){
    e.appendChild(document.createElement("br"));
  }
  return e;
}

function objArrayExtractKeyArray(obj_array, keyname) {
  let key_array = [];
  for(let i = 0; i < obj_array.length;i++){
    key_array.push(obj_array[i][keyname]);
  }
  return key_array;
}

function save_deck_recipe() {

  pageHome();
}

function addDom(el){
  document.body.appendChild(el);
}

function pageHome(){

  clearPage();
  document.body.style.margin = "2rem";

  addDom(makeNode("div","Yi Gi Oh - Print Your Deck","title"));
  addDom(makeSpace(1));

  addDom(makeNode("div","Step 1 (optional): Create your own Deck","subtitle"));
  addDom(makeSpace(1));

  addDom(makeButton("Create Deck", "wide_button", pageCreateDeck));
  addDom(makeSpace(1));

  addDom(makeNode("div","Step 2: Pick one Deck from the list","subtitle"));
  addDom(makeSpace(1));

  addDom(setId(makeSelect(objArrayExtractKeyArray(DECKS_LIST, "name"), tell_deck),"chosen_id"));
  addDom(makeSpace(1));

  addDom(setId(makeNode("div","","description_label"), "description"));
  addDom(makeSpace(1));

  addDom(makeCheckBox("Allow print for card-backs (This adds 'card-backs' pages)","allow_back_check"));
  addDom(makeSpace(1));

  addDom(makeNode("div","Step 3: Generate the Printable PDF","subtitle"));
  addDom(makeSpace(1));

  addDom(makeNode("div","When you are ready, hit the \"Generate Printable Deck Page\" button to see the ready-to-print Deck page. For best results, you must save the whole page by right-clicking the page and printing as PDF. Remember to use A4 format and no margins.","infobox"));
  addDom(makeSpace(1));

  addDom(makeButton("Generate Printable Deck Page", "wide_button", process_deck));
  addDom(makeSpace(1));

  tell_deck();
}

function search_by_name() {

}

function search_by_effect() {

}


function makeTextEntry(placeholder, onchange) {
  let d = makeNode("input",null,null);
  d.type = "text";
  d.className = "text_entry";
  d.placeholder = placeholder;
  d.onchange = onchange;
  return d;
}

function cardMatchesFilter(card, s_name, s_effect, level, attribute, type){

  if(card["Name"] == ""){
    return false;
  }

  if(s_name != "" && card["Name"].toLocaleLowerCase().indexOf(s_name) == -1){
    return false;
  }
  if(s_effect != "" && card["Meta"]["Effect"].toLocaleLowerCase().indexOf(s_effect) == -1){
    return false;
  }
  if(level != "any" && card["Stars"] != +level){
    return false;
  }
  if(attribute != "any" && card["Meta"]["Attribute"].toLocaleLowerCase().indexOf(attribute) == -1){
    return false;
  }
  if(type != "any"){

    let card_type = card["Type"];

    let type_spl = type.replace("(","").replace(")","").split(" ");
    let type_main = type_spl[0];
    let type_sub = type_spl[1];

    if(type_sub != "any" && card_type.indexOf(type_sub) == -1){
      return false;
    }else{
      if(type_main == "Trap" && card_type.indexOf("Trap") == -1){
        return false;
      }
      if(type_main == "Spell" && card_type.indexOf("Spell") == -1){
        return false;
      }
      if(type_main == "Monster" && (card_type.indexOf("Spell") != -1 || card_type.indexOf("Trap") != -1)){
        return false;
      }
    }
  }

  return true;
}

function filterCards(s_name, s_effect, level, attribute, type) {

  let card_filtered = [];

  for(let i = 0; i < CARDS_DB.length; i++){
    let card = CARDS_DB[i];
    if(cardMatchesFilter(card, s_name.toLocaleLowerCase(), s_effect.toLocaleLowerCase(), level.toLocaleLowerCase(), attribute.toLocaleLowerCase(), type.toLocaleLowerCase())){
      card_filtered.push(card);
    }
  }

  return card_filtered;
}

function searchCard() {

  let s_name = document.getElementById("name_search_id").value;
  let s_effect = document.getElementById("effect_search_id").value;
  let level = document.getElementById("level_id").value;
  let attribute = document.getElementById("attribute_id").value;
  let type = document.getElementById("type_id").value;

  let filtered = filterCards(s_name, s_effect, level, attribute, type);
  clearFilterBox();
  for(let i = 0; i < filtered.length; i++){
    addFilteredBoxToRecipe(filtered[i]);
  }
}

function getCardDescription(card) {

  let desc = "";

  desc += "<strong>"+card["Name"]+ "</strong>" + "\n";
  if(card["Stars"] != 0 && card["Type"].indexOf("Link") != -1){
    desc += "Link Level: " + card["Stars"] + "\n";
  }
  else if(card["Stars"] != 0 && card["Type"].indexOf("Xyz") != -1){
    desc += "Rank: " + card["Stars"] + "\n";
  }
  else if(card["Stars"] != 0){
    desc += "Level: " + card["Stars"] + "\n";
  }

  if(card["Type"].indexOf("Spell") == -1 && card["Type"].indexOf("Trap") ==-1){
    desc += "Attribute: " + card["Meta"]["Attribute"] + "\n";

    if(card["Meta"]["ATK"] != 0){
      desc += "ATK " + card["Meta"]["ATK"].toString() + "\n";
    }
    if(card["Type"].indexOf("Link") == -1){
      if(card["Meta"]["DEF"] != 0){
        desc += "DEF " + card["Meta"]["DEF"].toString() + "\n";
      }
    }
  }


  desc += "Type: " + card["Type"] + "\n\n";
  desc += card["Meta"]["Effect"];

  return desc;
}

function clearFilterBox() {
  let box = document.getElementById("filtered_cards_results");
  while(box.firstChild){
    box.removeChild(box.firstChild);
  }
}

function removeCardFromRecipe(element){
  element.parentNode.removeChild(element);
}

function getRecipeDescription(){
  let d = document.getElementById("recipe_box");
  for(let i = 0; i < d.children.length; i++){

  }
}

function addCardToRecipe(cardImg) {
  let c = makeNode("img", "", "card_in_recipe");
  c.src = "./Core_All_Cards/"+ cardImg + ".png";
  c.setAttribute("onclick", "removeCardFromRecipe(this)");
  let d = document.getElementById("recipe_box");
  d.appendChild(c);
}

function addFilteredBoxToRecipe(card){
  let box = document.getElementById("filtered_cards_results");

  let table = makeNode("table", "", "card_slot");
  table.setAttribute("onclick" , "addCardToRecipe('"+card["Img"]+"')");
  let row = makeNode("tr","","");
  let cell_1 = makeNode("td", "", "");
  let cell_2 = makeNode("td", "", "");

  let card_i = makeNode("img", "", "filtered_img");
  card_i.src = "./Core_All_Cards/"+card["Img"] + ".png";
  cell_1.appendChild(card_i);

  let card_d = makeNode("div", getCardDescription(card), "card_description");
  cell_2.appendChild(card_d);

  row.appendChild(cell_1);
  row.appendChild(cell_2);
  table.appendChild(row);
  box.appendChild(table);
}

function pageCreateDeck() {

  clearPage();
  document.body.style.margin = "2rem";

  addDom(makeNode("div","Create your own Deck","title"));
  addDom(makeSpace(1));

  addDom(makeNode("div","Step 1: Use the following filters to find Cards","subtitle"));
  addDom(makeSpace(1));

  addDom(setId(makeTextEntry("Search card by Name:", search_by_name), "name_search_id"));
  addDom(makeSpace(1));

  addDom(setId(makeTextEntry("Search card by Effect:", search_by_effect),"effect_search_id"));
  addDom(makeSpace(1));

  addDom(makeNode("div","Filter Level/Rank/Link-Level", "small_hint"));
  addDom(setId(makeSelect(["Any", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"], null),"level_id"));
  addDom(makeSpace(1));

  addDom(makeNode("div","Filter Attribute", "small_hint"));
  addDom(setId(makeSelect(["Any", "DARK",	"DIVINE",	"EARTH", "FIRE", "LIGHT", "WATER", "WIND"], null),"attribute_id"));
  addDom(makeSpace(1));

  addDom(makeNode("div","Filter Card Type", "small_hint"));
  addDom(setId(makeSelect(["Any", "Monster (any)", "Monster (Normal)", "Monster (Effect)", "Monster (Tuner)", "Monster (Fusion)", "Monster (Ritual)", "Monster (Xyz)", "Monster (Link)", "Monster (Synchro)", "Monster (Pendulum)", "Spell (any)", "Spell (Normal)", "Spell (Quick-Play)", "Spell (Field)", "Spell (Continuous)", "Spell (Ritual)", "Spell (Equip)",  "Trap (any)", "Trap (Normal)", "Trap (Counter)", "Trap (Continuous)"], null),"type_id"));
  addDom(makeSpace(1));

  addDom(makeButton("Search Cards", "wide_button", searchCard));
  addDom(makeSpace(1));

  addDom(makeNode("div","Click on a card to add it to the Deck Recipe", "small_hint"));
  addDom(setId(makeNode("div","", "filter_box"),"filtered_cards_results"));
  addDom(makeSpace(1));

  addDom(makeNode("div","Step 2: Verify your Deck Recipe","subtitle"));
  addDom(makeSpace(1));

  addDom(makeNode("div","Click on each card to remove it", "small_hint"));
  addDom(setId(makeNode("div","", "filter_box"),"recipe_box"));
  addDom(makeSpace(1));

  addDom(makeNode("div","Step 3: Save the Deck Recipe to use it","subtitle"));
  addDom(makeSpace(1));

  addDom(makeButton("Save Deck Recipe", "wide_button", save_deck_recipe));
  addDom(makeSpace(1));

  addDom(makeNode("div","Or just go back (All work will be lost)", "small_hint"));
  addDom(makeButton("Go Back", "wide_button", pageHome));
  addDom(makeSpace(1));

}

function setup() {
  pageHome();
}
